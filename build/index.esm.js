import"reflect-metadata";import{useSyncExternalStore as t,createContext as e,useContext as n,useMemo as s,useEffect as i}from"react";import{jsx as r}from"react/jsx-runtime";class a{constructor(){this.instances=new Map,this.services=new Map}registerService(t){this.services.set(t.token,t)}resolve(t){const e=this.services.get(t);return"transient"===(null==e?void 0:e.lifecycle)?this.create(t):(this.instances.has(t)||this.instances.set(t,this.create(t)),this.instances.get(t))}get(t){return this.resolve(t)}create(t){return new t(...(Reflect.getMetadata("design:paramtypes",t)||[]).map(t=>this.resolve(t)))}}class o{constructor(){this.handlers=new Map,this.middlewares=[]}use(t){this.middlewares.push(t)}on(t,e){const n=this.handlers.get(t)||[];n.push(e),this.handlers.set(t,n)}async dispatch(t){const e={intent:t,metadata:{}};let n=-1;const s=async i=>{var r,a;if(i<=n)throw new Error("next() called twice");n=i;const o=this.middlewares[i];o?await o(e,()=>s(i+1)):await Promise.all(null!==(a=null===(r=this.handlers.get(t.type))||void 0===r?void 0:r.map(e=>e(t)))&&void 0!==a?a:[])};await s(0)}onScoped(t,e,n){return this.on(`${t}/${e}`,n)}dispatchScoped(t,e,n){return this.dispatch({type:`${t}/${e}`,payload:n})}}class c{constructor(){this.effects=new Map,this.trackers=new Set}on(t,e){this.effects.has(t)||this.effects.set(t,new Set);const n=this.effects.get(t);return n.add(e),()=>{n.delete(e),0===n.size&&this.effects.delete(t)}}emit(t){const e=this.effects.get(t);e&&e.forEach(e=>{const n=performance.now();try{try{e()}catch(e){console.error("[Effect]",t,e)}}finally{const e=performance.now()-n;this.notifyTrackers({name:t,duration:e})}})}track(t){return this.trackers.add(t),()=>this.trackers.delete(t)}async run(t,e){const n=performance.now(),s=await e(),i=performance.now()-n;return this.trackers.forEach(e=>e({name:t,duration:i})),s}notifyTrackers(t){this.trackers.forEach(e=>{try{e(t)}catch(t){console.error("[EffectManager] tracker error",t)}})}has(t){return this.effects.has(t)}clear(){this.effects.clear(),this.trackers.clear()}}function l(t,e){if(!t.capabilities.includes(e))throw new Error(`[Plugin:${t.id}] Missing capability: "${e}"`)}class h{constructor(){this.container=new a,this.intent=new o,this.effect=new c,this.modules=new Map,this.$on=this.intent.on.bind(this.intent),this.$emit=this.intent.dispatch.bind(this.intent),this.$onIntent=this.intent.onScoped.bind(this.intent),this.$emitIntent=this.intent.dispatchScoped.bind(this.intent)}use(t){const e=(n=this,s=t.manifest,{intent:{tap(t){l(s,"intent"),n.intent.use(async(e,n)=>{t(e.intent),await n()})},on:(t,e)=>(l(s,"intent"),n.intent.on(t,e))},effect:{track:t=>(l(s,"effect"),n.effect.track(e=>{t({pluginId:s.id,name:e.name,duration:e.duration})}))},store:{observe(t){l(s,"store")}},runtime:{log(...t){console.log(`[plugin:${s.name}]`,...t)},version:()=>"0.1.0"},service:{get:t=>(l(s,"service"),n.container.get(t))},meta:{id:s.id,name:s.name}});var n,s;t.setup(e)}useModule(t){this.modules.set(t.name,t)}async initModules(){this.modules.forEach(t=>{var e,n;null===(e=t.dependencies)||void 0===e||e.forEach(e=>{var n,s;null===(s=null===(n=this.modules.get(e))||void 0===n?void 0:n.onModuleLoaded)||void 0===s||s.call(n,t)}),t.setup(this),null===(n=t.onInit)||void 0===n||n.call(t,this)})}destroyModules(){this.modules.forEach(t=>{var e;return null===(e=t.onDestroy)||void 0===e?void 0:e.call(t)})}getModule(t){return this.modules.get(t)}}function u(){return new h}function d(t){return t}function f(t={}){return function(e){Reflect.defineMetadata("service:def",Object.assign({token:e,lifecycle:"singleton"},t),e),globalThis.__injectableRegistry||(globalThis.__injectableRegistry=new Set),globalThis.__injectableRegistry.add(e)}}function p(t){return t}class m{constructor(t){this.state=t,this.listeners=new Set,this.computed=new Map,this.observers=new Set,this.id=`store-${Math.random().toString(36).slice(2,10)}`}get(){return this.state}set(t){this.state=Object.assign(Object.assign({},this.state),t),this.listeners.forEach(t=>t(this.state)),this.observers.forEach(t=>t({storeId:this.id,nextState:this.state}))}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}computedValue(t,e){this.computed.set(t,e)}getComputed(t){var e;return null===(e=this.computed.get(t))||void 0===e?void 0:e(this.state)}observe(t){return this.observers.add(t),()=>this.observers.delete(t)}}function v(e){return t(e.subscribe.bind(e),()=>e.get())}function g(t,e,n){let s,i=!1;t.computedValue(e,()=>s);const r=async()=>{if(!i){i=!0;try{s=await n(t.get()),t.set({})}finally{i=!1}}},a=t.subscribe(r);return r(),()=>{a()}}async function w(t){const e=await import(t.url);return t.exportName?e[t.exportName]:e.default}const b={manifest:{id:"observability",name:"ObservabilityPlugin",capabilities:["intent"]},setup(t){t.intent.tap(t=>{console.log("[Intent]",t.type)})}},y=e(null),M=({runtime:t,children:e})=>r(y.Provider,{value:t,children:e});function k(){const t=n(y);if(!t)throw new Error("No Runtime");return t}function $(t){return k().container.resolve(t)}function E(t){const e=k();return(n,s)=>{e.intent.dispatch({type:t?`${t}/${n}`:n,payload:s})}}function S(e,n=[]){const i=s(()=>{let t=null;return e=>(t=j(),()=>{null==t||t()})},n);return t(i,e,e)}let j=t=>()=>{};function x(t,e){const n=k();i(()=>{const s=n.effect.on(t,e);return()=>{null==s||s()}},[n,t,e])}export{h as AppRuntime,c as EffectManager,f as Injectable,b as ObservabilityPlugin,M as RuntimeProvider,m as Store,g as computedAsync,u as createApp,p as createModule,d as defineService,w as loadRemotePlugin,S as useComputed,x as useEffectIntent,E as useIntent,$ as useModule,k as useRuntime,v as useStore};
