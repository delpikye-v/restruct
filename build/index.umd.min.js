!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("reflect-metadata"),require("react"),require("react/jsx-runtime")):"function"==typeof define&&define.amd?define(["exports","reflect-metadata","react","react/jsx-runtime"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Restructz={},null,e.react,e.jsxRuntime)}(this,function(e,t,n,s){"use strict";class i{constructor(){this.instances=new Map,this.services=new Map}registerService(e){this.services.set(e.token,e)}resolve(e){const t=this.services.get(e);return"transient"===(null==t?void 0:t.lifecycle)?this.create(e):(this.instances.has(e)||this.instances.set(e,this.create(e)),this.instances.get(e))}get(e){return this.resolve(e)}create(e){return new e(...(Reflect.getMetadata("design:paramtypes",e)||[]).map(e=>this.resolve(e)))}}class r{constructor(){this.handlers=new Map,this.middlewares=[]}use(e){this.middlewares.push(e)}on(e,t){const n=this.handlers.get(e)||[];n.push(t),this.handlers.set(e,n)}async dispatch(e){const t={intent:e,metadata:{}};let n=-1;const s=async i=>{var r,a;if(i<=n)throw new Error("next() called twice");n=i;const o=this.middlewares[i];o?await o(t,()=>s(i+1)):await Promise.all(null!==(a=null===(r=this.handlers.get(e.type))||void 0===r?void 0:r.map(t=>t(e)))&&void 0!==a?a:[])};await s(0)}onScoped(e,t,n){return this.on(`${e}/${t}`,n)}dispatchScoped(e,t,n){return this.dispatch({type:`${e}/${t}`,payload:n})}}class a{constructor(){this.effects=new Map,this.trackers=new Set}on(e,t){this.effects.has(e)||this.effects.set(e,new Set);const n=this.effects.get(e);return n.add(t),()=>{n.delete(t),0===n.size&&this.effects.delete(e)}}emit(e){const t=this.effects.get(e);t&&t.forEach(t=>{const n=performance.now();try{try{t()}catch(t){console.error("[Effect]",e,t)}}finally{const t=performance.now()-n;this.notifyTrackers({name:e,duration:t})}})}track(e){return this.trackers.add(e),()=>this.trackers.delete(e)}async run(e,t){const n=performance.now(),s=await t(),i=performance.now()-n;return this.trackers.forEach(t=>t({name:e,duration:i})),s}notifyTrackers(e){this.trackers.forEach(t=>{try{t(e)}catch(e){console.error("[EffectManager] tracker error",e)}})}has(e){return this.effects.has(e)}clear(){this.effects.clear(),this.trackers.clear()}}function o(e,t){if(!e.capabilities.includes(t))throw new Error(`[Plugin:${e.id}] Missing capability: "${t}"`)}class c{constructor(){this.container=new i,this.intent=new r,this.effect=new a,this.modules=new Map,this.$on=this.intent.on.bind(this.intent),this.$emit=this.intent.dispatch.bind(this.intent),this.$onIntent=this.intent.onScoped.bind(this.intent),this.$emitIntent=this.intent.dispatchScoped.bind(this.intent)}use(e){const t=(n=this,s=e.manifest,{intent:{tap(e){o(s,"intent"),n.intent.use(async(t,n)=>{e(t.intent),await n()})},on:(e,t)=>(o(s,"intent"),n.intent.on(e,t))},effect:{track:e=>(o(s,"effect"),n.effect.track(t=>{e({pluginId:s.id,name:t.name,duration:t.duration})}))},store:{observe(e){o(s,"store")}},runtime:{log(...e){console.log(`[plugin:${s.name}]`,...e)},version:()=>"0.1.0"},service:{get:e=>(o(s,"service"),n.container.get(e))},meta:{id:s.id,name:s.name}});var n,s;e.setup(t)}useModule(e){this.modules.set(e.name,e)}async initModules(){this.modules.forEach(e=>{var t,n;null===(t=e.dependencies)||void 0===t||t.forEach(t=>{var n,s;null===(s=null===(n=this.modules.get(t))||void 0===n?void 0:n.onModuleLoaded)||void 0===s||s.call(n,e)}),e.setup(this),null===(n=e.onInit)||void 0===n||n.call(e,this)})}destroyModules(){this.modules.forEach(e=>{var t;return null===(t=e.onDestroy)||void 0===t?void 0:t.call(e)})}getModule(e){return this.modules.get(e)}}const l={manifest:{id:"observability",name:"ObservabilityPlugin",capabilities:["intent"]},setup(e){e.intent.tap(e=>{console.log("[Intent]",e.type)})}},u=n.createContext(null);function d(){const e=n.useContext(u);if(!e)throw new Error("No Runtime");return e}let h=e=>()=>{};e.AppRuntime=c,e.EffectManager=a,e.Injectable=function(e={}){return function(t){Reflect.defineMetadata("service:def",Object.assign({token:t,lifecycle:"singleton"},e),t),globalThis.__injectableRegistry||(globalThis.__injectableRegistry=new Set),globalThis.__injectableRegistry.add(t)}},e.ObservabilityPlugin=l,e.RuntimeProvider=({runtime:e,children:t})=>s.jsx(u.Provider,{value:e,children:t}),e.Store=class{constructor(e){this.state=e,this.listeners=new Set,this.computed=new Map,this.observers=new Set,this.id=`store-${Math.random().toString(36).slice(2,10)}`}get(){return this.state}set(e){this.state=Object.assign(Object.assign({},this.state),e),this.listeners.forEach(e=>e(this.state)),this.observers.forEach(e=>e({storeId:this.id,nextState:this.state}))}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}computedValue(e,t){this.computed.set(e,t)}getComputed(e){var t;return null===(t=this.computed.get(e))||void 0===t?void 0:t(this.state)}observe(e){return this.observers.add(e),()=>this.observers.delete(e)}},e.computedAsync=function(e,t,n){let s,i=!1;e.computedValue(t,()=>s);const r=async()=>{if(!i){i=!0;try{s=await n(e.get()),e.set({})}finally{i=!1}}},a=e.subscribe(r);return r(),()=>{a()}},e.createApp=function(){return new c},e.createModule=function(e){return e},e.defineService=function(e){return e},e.loadRemotePlugin=async function(e){const t=await import(e.url);return e.exportName?t[e.exportName]:t.default},e.useComputed=function(e,t=[]){const s=n.useMemo(()=>{let e=null;return t=>(e=h(),()=>{null==e||e()})},t);return n.useSyncExternalStore(s,e,e)},e.useEffectIntent=function(e,t){const s=d();n.useEffect(()=>{const n=s.effect.on(e,t);return()=>{null==n||n()}},[s,e,t])},e.useIntent=function(e){const t=d();return(n,s)=>{t.intent.dispatch({type:e?`${e}/${n}`:n,payload:s})}},e.useModule=function(e){return d().container.resolve(e)},e.useRuntime=d,e.useStore=function(e){return n.useSyncExternalStore(e.subscribe.bind(e),()=>e.get())}});
