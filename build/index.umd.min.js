!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("reflect-metadata"),require("react"),require("react/jsx-runtime")):"function"==typeof define&&define.amd?define(["exports","reflect-metadata","react","react/jsx-runtime"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Restructz={},null,e.react,e.jsxRuntime)}(this,function(e,t,s,n){"use strict";class i{constructor(){this.instances=new Map,this.services=new Map}registerService(e){this.services.set(e.token,e)}resolve(e){const t=this.services.get(e);return"transient"===(null==t?void 0:t.lifecycle)?this.create(e):(this.instances.has(e)||this.instances.set(e,this.create(e)),this.instances.get(e))}get(e){return this.resolve(e)}create(e){return new e(...(Reflect.getMetadata("design:paramtypes",e)||[]).map(e=>this.resolve(e)))}}class r{constructor(){this.handlers=new Map,this.middlewares=[]}use(e){this.middlewares.push(e)}on(e,t){const s=this.handlers.get(e)||[];s.push(t),this.handlers.set(e,s)}async dispatch(e){const t={intent:e,metadata:{}};let s=-1;const n=async i=>{var r,o;if(i<=s)throw new Error("next() called twice");s=i;const a=this.middlewares[i];a?await a(t,()=>n(i+1)):await Promise.all(null!==(o=null===(r=this.handlers.get(e.type))||void 0===r?void 0:r.map(t=>t(e)))&&void 0!==o?o:[])};await n(0)}onScoped(e,t,s){return this.on(`${e}/${t}`,s)}dispatchScoped(e,t,s){return this.dispatch({type:`${e}/${t}`,payload:s})}}class o{constructor(){this.effects=new Map,this.trackers=new Set}on(e,t){this.effects.has(e)||this.effects.set(e,new Set);const s=this.effects.get(e);return s.add(t),()=>{s.delete(t),0===s.size&&this.effects.delete(e)}}emit(e){const t=this.effects.get(e);t&&t.forEach(t=>{const s=performance.now();try{try{t()}catch(t){console.error("[Effect]",e,t)}}finally{const t=performance.now()-s;this.notifyTrackers({name:e,duration:t})}})}track(e){return this.trackers.add(e),()=>this.trackers.delete(e)}async run(e,t){const s=performance.now(),n=await t(),i=performance.now()-s;return this.trackers.forEach(t=>t({name:e,duration:i})),n}notifyTrackers(e){this.trackers.forEach(t=>{try{t(e)}catch(e){console.error("[EffectManager] tracker error",e)}})}has(e){return this.effects.has(e)}clear(){this.effects.clear(),this.trackers.clear()}}function a(e,t){if(!e.capabilities.includes(t))throw new Error(`[Plugin:${e.id}] Missing capability: "${t}"`)}class c{constructor(){this.container=new i,this.intent=new r,this.effect=new o,this.modules=new Map,this.stores=[],this.$on=this.intent.on.bind(this.intent),this.$emit=this.intent.dispatch.bind(this.intent),this.$onIntent=this.intent.onScoped.bind(this.intent),this.$emitIntent=this.intent.dispatchScoped.bind(this.intent)}registerStore(e){this.stores.push(e)}use(e){const t=(s=this,n=e.manifest,{intent:{tap(e){a(n,"intent"),s.intent.use(async(t,s)=>{e(t.intent),await s()})},on:(e,t)=>(a(n,"intent"),s.intent.on(e,t))},effect:{track:e=>(a(n,"effect"),s.effect.track(t=>{e({pluginId:n.id,name:t.name,duration:t.duration})}))},store:{observe(e){a(n,"store"),s.getStores().forEach(t=>t.observe(e))}},runtime:{log(...e){console.log(`[plugin:${n.name}]`,...e)},version:()=>"0.1.0"},service:{get:e=>(a(n,"service"),s.container.get(e))},meta:{id:n.id,name:n.name}});var s,n;e.setup(t)}useModule(e){this.modules.set(e.name,e)}async initModules(){this.modules.forEach(e=>{var t,s;null===(t=e.dependencies)||void 0===t||t.forEach(t=>{var s,n;null===(n=null===(s=this.modules.get(t))||void 0===s?void 0:s.onModuleLoaded)||void 0===n||n.call(s,e)}),e.setup(this),null===(s=e.onInit)||void 0===s||s.call(e,this)})}destroyModules(){this.modules.forEach(e=>{var t;return null===(t=e.onDestroy)||void 0===t?void 0:t.call(e)})}getModule(e){return this.modules.get(e)}getStores(){return this.stores}}const u={manifest:{id:"observability",name:"ObservabilityPlugin",capabilities:["intent"]},setup(e){e.intent.tap(e=>{console.log("[Intent]",e.type)})}},l=s.createContext(null);function d(){const e=s.useContext(l);if(!e)throw new Error("No Runtime");return e}let h=e=>()=>{};e.AppRuntime=c,e.EffectManager=o,e.Injectable=function(e={}){return function(t){Reflect.defineMetadata("service:def",Object.assign({token:t,lifecycle:"singleton"},e),t),globalThis.__injectableRegistry||(globalThis.__injectableRegistry=new Set),globalThis.__injectableRegistry.add(t)}},e.ObservabilityPlugin=u,e.RuntimeProvider=({runtime:e,children:t})=>n.jsx(l.Provider,{value:e,children:t}),e.Store=class{constructor(e,t){this.state=e,this.pluginLogId=t,this.listeners=new Set,this.computed=new Map,this.observers=new Set,this.id=`store-${Math.random().toString(36).slice(2,10)}`,this.id=t||this.id}get(){return this.state}set(e){this.state=Object.assign(Object.assign({},this.state),e),this.listeners.forEach(e=>e(this.state)),this.observers.forEach(e=>e({storeId:this.id,nextState:this.state}))}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}computedValue(e,t){this.computed.set(e,t)}getComputed(e){var t;return null===(t=this.computed.get(e))||void 0===t?void 0:t(this.state)}observe(e){return this.observers.add(e),()=>this.observers.delete(e)}watch(e){return e(this.state),this.subscribe(e)}},e.computedAsync=function(e,t,s){let n,i=!1;e.computedValue(t,()=>n);const r=async()=>{if(!i){i=!0;try{n=await s(e.get()),e.set({})}finally{i=!1}}},o=e.subscribe(r);return r(),()=>{o()}},e.createApp=function(){return new c},e.createModule=function(e){return e},e.defineService=function(e){return e},e.loadRemotePlugin=async function(e){const t=await import(e.url);return e.exportName?t[e.exportName]:t.default},e.registerService=function(e,t){const s=Reflect.getMetadata("service:def",t);s&&e.container.registerService(s)},e.useComputed=function(e,t=[]){const n=s.useMemo(()=>{let e=null;return t=>(e=h(),()=>{null==e||e()})},t);return s.useSyncExternalStore(n,e,e)},e.useEffectIntent=function(e,t){const n=d();s.useEffect(()=>{const s=n.effect.on(e,t);return()=>{null==s||s()}},[n,e,t])},e.useIntent=function(e){const t=d();return(s,n)=>{t.intent.dispatch({type:e?`${e}/${s}`:s,payload:n})}},e.useModule=function(e){return d().container.resolve(e)},e.useModuleInstance=function(e){const t=d().getModule(e);if(!t)throw new Error(`Module ${e} not found`);return t},e.useRuntime=d,e.useStore=function(e){return s.useSyncExternalStore(e.subscribe.bind(e),()=>e.get())}});
